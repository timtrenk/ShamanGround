version: 1.0
name: "Thoth_engine_1.0"
description: Full engine braid spec wired for trap_seeds, Metatron (7-gate), harmonizers, BFF, thresholds,
  and telemetry.
imports:
  trap_seeds: trap_seeds.yaml
  metatron_function: metatron_function.yaml
  bff: braided-feedback-function.yaml
  harmonizers: harmonizers.extended.yaml
  thresholds: thresholds_1.1.yaml
contracts:
  packet.out:
    required_fields:
    - payload
    - residuals
    - metrics
    - ts
    metrics_minimum_keys:
    - coherence
    - intensity
    - stability
    ts_format: iso-8601
  hooks:
    after_gate:
    - harmonizers.apply
    before_bff:
    - harmonizers.flush
input_optimization:
  enabled: true
  steps:
  - normalize_text
  - strip_placeholders
  - timestamp_align
  - z_score_metrics
  - smooth_residuals
  - weight_by_threshold_confidence
  notes: "Mirrors/traps map \u2192 thresholds gate \u2192 harmonizers polish \u2192 BFF synth."
meta_gate:
  driver: metatron_function
  config_ref: metatron_function.yaml#metatron
  notes:
  - Planner/orchestrator for 7-gate set; non-transform roles live in policies/harmonizers/runtime.
trap_mapping:
  dataset: trap_seeds
  map_fields:
  - trap_id
  - family
  - variant
  - resonance_pattern
  - disruption_pattern
  - guidance
  emit_into: thresholds.inputs.trap_context
gates:
  G01:
    name: Severance
    role: cut non-authored overlays
    out_schema: packet.out
  G02:
    name: Voice Clarity
    role: tone + level alignment
    out_schema: packet.out
  G03:
    name: Order
    role: structure & step sequencing
    out_schema: packet.out
  G04:
    name: Direction
    role: goal vector & constraint set
    out_schema: packet.out
  G05:
    name: Relational
    role: context + empathy restoration
    out_schema: packet.out
  G06:
    name: Integration
    role: merge safe deltas
    out_schema: packet.out
  G07:
    name: Crown Verification
    role: final allow/flag/block
    out_schema: packet.out
flow:
  sequence:
  - G01
  - G02
  - G03
  - G04
  - G05
  - G06
  - G07
  hooks:
    after_each_gate: harmonizers.apply
    before_bff: harmonizers.flush
  bff:
    center: G01
    orbitals:
    - G02
    - G03
    - G04
    - G05
    - G06
    - G07
    pole: Meta-Gate
    signature_emit: bff_signature
bff_integration:
  inputs:
    severance_core: G01.out
    orbital_gates:
    - G02.out
    - G03.out
    - G04.out
    - G05.out
    - G06.out
    - G07.out
    meta_pole: meta_gate
    harmonizer_state: harmonizers.state
  input_optimization:
    normalize: true
    smooth_window: 3
    weighting:
      center: 1.0
      orbitals: 0.88
      clarity_bias: 0.06
  outputs:
    bff_signature:
      fields:
      - axial
      - radial
      - clarity
      - learning_delta
      - coherence_hash
telemetry:
  record:
  - gate_outputs.pre_harmonizer
  - gate_outputs.post_harmonizer
  - thresholds.decisions
  - meta_gate.gate_plan
  - bff.signature
  receipt_policy:
    on_demand: true
    on_thread_end: true
    redact_keys:
    - payload.raw_text
    - secrets
    - api_key
definitions:
  normalize_text: lowercase, collapse whitespace, unicode NFC
  strip_placeholders: remove [TODO], <placeholder>, {{var}} artifacts
  timestamp_align: align ts to nearest gate cycle
  z_score_metrics: normalize metrics by rolling z-score
  smooth_residuals: EWMA smoothing on residual vectors
